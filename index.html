<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω thu√™ ph√≤ng tr·ªç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles.css" />
</head>

<body>
    <h1>Qu·∫£n l√Ω thu√™ ph√≤ng tr·ªç</h1>

    <input type="text" id="search" placeholder="üîç T√¨m theo m√£ ph√≤ng ho·∫∑c t√™n ng∆∞·ªùi thu√™..." />

    <button id="show-form-btn">‚ûï Th√™m m·ªõi</button>

    <div id="modal-overlay">
        <div id="room-form-container">
            <form id="room-form">
                <div class="form-group">
                    <label for="tenantName">T√™n ng∆∞·ªùi thu√™ *</label>
                    <input type="text" id="tenantName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu√™" required />

                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />

                    <label for="startDate">Ng√†y b·∫Øt ƒë·∫ßu thu√™ *</label>
                    <input type="date" id="startDate" required />

                    <label for="paymentMethod">H√¨nh th·ª©c thanh to√°n *</label>
                    <select id="paymentMethod" required>
                        <option value="">Ch·ªçn h√¨nh th·ª©c thanh to√°n</option>
                    </select>

                    <label for="note">Ghi ch√∫</label>
                    <input type="text" id="note" placeholder="Nh·∫≠p ghi ch√∫" />
                </div>

                <div class="form-buttons">
                    <button type="submit">‚úÖ T·∫°o m·ªõi</button>
                    <button type="button" id="cancel-btn">‚ùå Hu·ª∑</button>
                </div>
            </form>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>M√£ ph√≤ng</th>
                <th>T√™n ng∆∞·ªùi thu√™</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                <th>H√¨nh th·ª©c thanh to√°n</th>
                <th>Ghi ch√∫</th>
                <th>H√†nh ƒë·ªông</th>
                <th>X√≥a nhi·ªÅu</th>
            </tr>
        </thead>
        <tbody id="room-list"></tbody>
    </table>

    <div id="delete-confirmation" style="display: none;">
        <div id="delete-confirm-container">
            <h3>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√°c ph√≤ng ƒë√£ ch·ªçn kh√¥ng?</h3>
            <button id="confirm-delete">X√≥a</button>
            <button id="cancel-delete">H·ªßy</button>
        </div>
    </div>

    <script>
        const API = "http://localhost:3000";
        const roomList = document.getElementById("room-list");
        const form = document.getElementById("room-form");
        const formContainer = document.getElementById("room-form-container");
        const showFormBtn = document.getElementById("show-form-btn");
        const cancelBtn = document.getElementById("cancel-btn");
        const search = document.getElementById("search");
        const paymentSelect = document.getElementById("paymentMethod");


        let allRooms = [];

        const modalOverlay = document.getElementById("modal-overlay");

        showFormBtn.addEventListener("click", () => {
            modalOverlay.style.display = "flex";
        });

        cancelBtn.addEventListener("click", () => {
            form.reset();
            modalOverlay.style.display = "none";
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const phone = document.getElementById("phone").value.trim();
            if (phone && !/^(0[0-9]{9,10})$/.test(phone)) {
                alert("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!");
                return;
            }

            const newRoom = {
                tenantName: document.getElementById("tenantName").value.trim(),
                phone: phone,
                startDate: document.getElementById("startDate").value,
                paymentMethodId: parseInt(document.getElementById("paymentMethod").value),
                note: document.getElementById("note").value.trim(),
            };

            await fetch(`${API}/rooms`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newRoom)
            });

            form.reset();
            modalOverlay.style.display = "none";
            await loadRooms();
        });


        async function loadPaymentMethods() {
            const res = await fetch(`${API}/payment_methods`);
            const data = await res.json();
            paymentSelect.innerHTML = data.map(method =>
                `<option value="${method.id}">${method.name}</option>`
            ).join("");
        }

        async function loadRooms() {
            const res = await fetch(`${API}/rooms`);
            const data = await res.json();
            allRooms = data;
            renderRooms(data);
        }

        function renderRooms(rooms) {
            roomList.innerHTML = "";
            rooms.forEach(room => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${room.id}</td>
          <td>${room.tenant_name}</td>
          <td>${room.phone || ""}</td>
          <td>${room.start_date}</td>
          <td>${room.payment_method}</td>
          <td>${room.note || ""}</td>
          <td><button onclick="deleteRoom(${room.id})">üóëÔ∏è Xo√°</button></td>
          <td><input type="checkbox" class="room-checkbox" data-id="${room.id}" onchange="handleCheckboxChange(${room.id}, this.checked)" /></td>
        `;
                roomList.appendChild(tr);
            });
        }

        async function deleteRoom(id) {
            await fetch(`${API}/rooms/${id}`, { method: "DELETE" });
            await loadRooms();
        }

        search.addEventListener("input", () => {
            const keyword = search.value.toLowerCase();
            const filtered = allRooms.filter(room =>
                room.id.toString().includes(keyword) ||
                room.tenant_name.toLowerCase().includes(keyword)
            );
            renderRooms(filtered);
        });

        loadPaymentMethods();
        loadRooms();
    </script>
</body>

</html>